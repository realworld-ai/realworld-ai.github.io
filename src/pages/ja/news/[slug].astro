---
import Layout from '../../../layouts/Layout.astro';
import PageHeader from '../../../components/PageHeader.astro';
import { getCollection, getEntry } from 'astro:content';
import { ArrowLeft } from 'lucide-react';

export async function getStaticPaths() {
    const news = await getCollection('news');
    return news.map(n => ({ params: { slug: (n.slug ?? n.id) } }));
}

const lang = 'ja';
const slug = Astro.params.slug as string;
const entry = await getEntry('news', slug);
if (!entry) {
    throw new Error(`News entry not found: ${slug}`);
}

const rendered = await entry.render();
const data = entry.data;
const cover = data.coverImage ?? '/images/news/placeholder.svg';
const hasBody = Boolean(entry.body && entry.body.trim().length > 0);
const description = data.summary ?? (hasBody ? null : '詳細は後日掲載します。');
---

<Layout title={`${data.title} | ニュース | 実世界知能基盤講座`} lang={lang}>
    <main class="pt-32 pb-20 max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <a href={`/${lang}/news`} id="back-link" class="inline-flex items-center text-sm font-medium text-gray-400 hover:text-white transition-colors mb-8 group">
            <ArrowLeft className="w-4 h-4 mr-2 group-hover:-translate-x-1 transition-transform" />
            一覧に戻る
        </a>
        <PageHeader title={data.title} subtitle={data.type === 'award' ? '受賞 / ハイライト' : '活動 / 更新'} />

        <script>
            const backLink = document.getElementById('back-link');
            if (backLink) {
                backLink.addEventListener('click', (e) => {
                    if (document.referrer && document.referrer.includes('/news')) {
                        e.preventDefault();
                        history.back();
                    }
                });
            }
        </script>

        <article class="prose prose-invert max-w-none mt-8">
            <img src={cover} alt={data.title} class="w-full rounded-lg mb-6 object-cover" />

            <div class="text-sm text-gray-400 mb-4">
                <time>{new Date(data.date).toLocaleDateString('ja-JP', { year: 'numeric', month: 'short', day: 'numeric' })}</time>
                {data.members && data.members.length > 0 && (
                    <div class="mt-2">{data.members.join(', ')}</div>
                )}
            </div>

            {hasBody ? (
                <div>
                    <rendered.Content />
                </div>
            ) : (
                <div class="rounded-lg border border-white/5 bg-gray-900/40 p-6">
                    <h4 class="text-lg font-bold text-white mb-2">{data.title}</h4>
                    <p class="text-gray-400">{description}</p>
                </div>
            )}
        </article>
    </main>
</Layout>
